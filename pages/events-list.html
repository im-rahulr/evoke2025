<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Select Events – Evoke 2k25</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/main.css?v=20251030">
  <style>
    .events-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin: 16px 0;
      padding-bottom: 32px; /* Default spacing; extra space only when summary is visible */
    }
    
    @media (min-width: 768px) {
      .events-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
    }
    
    @media (min-width: 1024px) {
      .events-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }
    }
    
    .event-card {
      background: rgba(0, 0, 0, 0.55);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 14px;
      transition: all 0.3s ease;
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 60px;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    }
    
    .event-card:hover {
      border-color: var(--primary);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .event-card.selected {
      border-color: var(--primary);
      background: rgba(123, 191, 68, 0.05);
    }
    
    .event-card .event-content {
      flex: 1;
      margin-right: 12px;
    }
    
    .event-card .event-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 2px;
      line-height: 1.2;
    }
    
    .event-card .event-description {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.3;
      margin-bottom: 0;
    }
    
    .event-card .event-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }
    
    .event-price-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--primary);
      color: #10210a;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .select-btn {
      padding: 6px 12px;
      border: 1px solid var(--primary);
      background: transparent;
      color: var(--primary);
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 11px;
      transition: all 0.3s ease;
      min-width: 65px;
      text-align: center;
    }
    
    .select-btn:hover {
      background: var(--primary);
      color: #10210a;
    }
    
    .select-btn.selected {
      background: var(--primary);
      color: #10210a;
    }
    

    
    .selection-summary {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.55);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px 12px 0 0;
      padding: 16px;
      margin: 0;
      display: none;
      z-index: 1000;
      box-shadow: 0 -8px 30px rgba(0,0,0,0.35);
      max-height: 50vh;
      overflow-y: auto;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    
    .summary-totals {
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: 12px;
      padding-top: 12px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 14px;
      color: var(--text);
    }
    
    .summary-row.total {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: 8px;
      padding-top: 8px;
    }
    
    .selection-summary.show {
      display: block;
    }
    
    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      font-size: 14px;
    }
    
    .user-info {
      background: rgba(0, 0, 0, 0.1);
      border: 1px solid var(--primary);
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 16px;
      display: inline-block;
    }
    
    .user-info h3 {
      margin: 0 0 4px 0;
      color: var(--primary);
      font-size: 14px;
    }
    
    .user-info p {
      margin: 2px 0;
      font-size: 12px;
      display: inline;
      margin-right: 12px;
    }
    
    .user-info-content {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    
    /* Mobile optimizations */
    @media (max-width: 767px) {
      .container {
        padding: 0 12px;
      }
      
      .events-grid {
        gap: 6px;
        margin: 12px 0;
        padding-bottom: 220px;
      }
      
      .event-card {
        padding: 10px;
        min-height: 55px;
      }
      
      .event-card .event-title {
        font-size: 13px;
      }
      
      .event-card .event-description {
        font-size: 10px;
      }
      
      .select-btn {
        padding: 5px 10px;
        font-size: 10px;
        min-width: 60px;
      }
      
      .user-info {
        padding: 6px 8px;
        margin-bottom: 10px;
      }
      
      .user-info h3 {
        font-size: 12px;
      }
      
      .user-info p {
        font-size: 10px;
        margin-right: 6px;
      }
      

    }
    
    /* Desktop optimizations */
    @media (min-width: 1200px) {
      .events-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    /* Add space for the fixed summary only when it's visible */
    body.has-summary .events-grid {
      padding-bottom: 220px;
    }

    /* Wider container for desktop to fit 3-4 columns nicely */
    @media (min-width: 1024px) {
      .container {
        max-width: 1200px;
      }
    }
  </style>
</head>
<body class="home-page">
  <main class="container" role="main">
    <header class="event-header">
      <div class="event-info">
        <div class="event-breadcrumb">
          <a href="../index.html">EVOKE 2K25</a> <span>/</span> <span>Select Events</span>
        </div>
        <h1 class="event-title">Choose Your Events</h1>
        <p class="event-subtitle">Select the events you want to participate in (₹100 per event pre-register / ₹150 on-spot)</p>
      </div>
    </header>

    <div id="userInfo" class="user-info" style="display: none;">
      <h3>Registration Details</h3>
      <div class="user-info-content">
        <p><strong>Name:</strong> <span id="userName"></span></p>
        <p><strong>Token:</strong> <span id="userToken"></span></p>
        <p><strong>College:</strong> <span id="userCollege"></span></p>
      </div>
    </div>

    <div class="events-grid" id="eventsGrid">
      <!-- Events will be loaded here -->
    </div>

    <div class="selection-summary" id="selectionSummary">
      <h3 style="margin-top: 0;">Selected Events</h3>
      <div id="summaryItems"></div>
      <div class="summary-totals">
        <div class="summary-row">
          <span>Events Selected:</span>
          <span id="eventCount">0</span>
        </div>
        <div class="summary-row total">
          <span>Total Amount:</span>
          <span id="totalAmount">₹0</span>
        </div>
      </div>
      <button class="btn btn-primary btn-block" id="proceedToPayment" style="margin-top: 16px;">
        Continue to Payment
      </button>
    </div>
    
    <div style="text-align: center; margin-top: 24px;">
      <a href="register.html" class="login-link" style="font-size: 14px;">← Back to Registration</a>
    </div>
  </main>

  <!-- Page Loader -->
  <div id="pageLoader" class="page-loader" aria-live="polite" aria-busy="false">
    <div class="spinner-standalone" aria-hidden="true"></div>
    <div id="loaderText" class="loader-text">Loading events...</div>
  </div>

  <script type="module">
    import { db } from '../assets/js/firebase-config.js';
    import { collection, doc, setDoc, updateDoc, getDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // Event data
    const EVENTS_DATA = [
      {
        id: 'dumb-charades',
        title: 'Dumb Charades',
        description: 'Team of 2. Act without speaking; 1 minute per word. 10 prompts, need 8 correct to qualify.',
        maxParticipants: 2
      },
      {
        id: 'general-quiz',
        title: 'G.K. Quiz',
        description: 'Two per team. Prelims written; finals oral. Includes Aptitude, Current Affairs, Sports, Science and more.',
        maxParticipants: 2
      },
      {
        id: 'fashion-show',
        title: 'Fashion Show (Indian Culture)',
        description: 'Individual. Modest attire, props allowed. 30s on stage.',
        maxParticipants: 1
      },
      {
        id: 'group-song',
        title: 'Group Song',
        description: '3–5 members. Max 4 mins. Any language; judged on vocals, musicality, presence and style.',
        maxParticipants: 5
      },
      {
        id: 'solo-singing',
        title: 'Solo Song',
        description: 'Individual. Max 2 mins. Any language; decent content. Own track/karaoke allowed.',
        maxParticipants: 1
      },
      {
        id: 'group-dance',
        title: 'Group Dance',
        description: '2–5 members. Theme: Cinematic. 3+1 mins; fusion allowed; no religious acts.',
        maxParticipants: 5
      },
      {
        id: 'solo-dance',
        title: 'Solo Dance',
        description: 'Individual. 4 mins. Free Style. Fusion allowed. No religious acts; decent performance.',
        maxParticipants: 1
      },
      {
        id: 'solo-instrumental',
        title: 'Instrumental Music',
        description: 'Individual. Bring your own instruments. Time limit 3 minutes.',
        maxParticipants: 1
      },
      {
        id: 'face-painting',
        title: 'Face Painting',
        description: 'Team of 2 (one paints on the other). Time limit 1 hour. Free Theme.',
        maxParticipants: 2
      },
      {
        id: 'fireless-cooking',
        title: 'Cooking Without Fire',
        description: 'Individual. 1½ hours. No fire; own utensils; no precooked items; creativity judged.',
        maxParticipants: 1
      },
      {
        id: 'vegetable-carving',
        title: 'Vegetable Carving',
        description: 'Individual. 1 hour. Bring own veggies and tools; follow given theme.',
        maxParticipants: 1
      },
      {
        id: 'pot-painting',
        title: 'Pot Painting',
        description: 'Pot provided. 1 hour. Only hand painting; bring materials; no spray paint.',
        maxParticipants: 1
      },
      {
        id: 'art-craft',
        title: 'Art and Craft',
        description: 'Individual. Bring own materials and tools. Time: 1 hour. Original work only.',
        maxParticipants: 1
      },
      {
        id: 'collage-competition',
        title: 'Collage Competition',
        description: 'Team of ≥2. Theme on the spot. Time 1 hour. Charts provided. Handmade only.',
        maxParticipants: 2
      },
      {
        id: 'pencil-sketch',
        title: 'Pencil Sketch',
        description: 'Individual. Theme on the spot. Papers provided. Graphite/charcoal only.',
        maxParticipants: 1
      },
      {
        id: 'best-waste',
        title: 'Best Out of Waste',
        description: 'Individual. 1½ hours. Only waste/recyclable materials; eco-friendly models.',
        maxParticipants: 1
      }
    ];

    let selectedEvents = {};
    let userContext = null;

    // DOM elements
    const eventsGrid = document.getElementById('eventsGrid');
    const selectionSummary = document.getElementById('selectionSummary');
    const summaryItems = document.getElementById('summaryItems');
    const proceedBtn = document.getElementById('proceedToPayment');
    const pageLoader = document.getElementById('pageLoader');
    const userInfo = document.getElementById('userInfo');

    function showLoader(message) {
      document.getElementById('loaderText').textContent = message || 'Loading...';
      pageLoader.classList.add('show');
    }

    function hideLoader() {
      pageLoader.classList.remove('show');
    }

    // Get user context from session storage
    function getUserContext() {
      try {
        const token = sessionStorage.getItem('lastToken');
        const name = sessionStorage.getItem('lastName');
        const college = sessionStorage.getItem('lastCollege');
        
        if (token && name) {
          return { token, name, college: college || 'N/A' };
        }
        return null;
      } catch (e) {
        console.warn('Unable to get user context:', e);
        return null;
      }
    }

    // Check if user already submitted events; if yes, skip this page
    function enforceSubmissionLock() {
      try {
        const token = sessionStorage.getItem('lastToken');
        const lockedToken = sessionStorage.getItem('events_submitted_token');
        if (token && lockedToken && token === lockedToken) {
          // Already submitted, redirect to success page
          window.location.replace('success.html');
          return true;
        }
      } catch (e) {
        console.warn('Lock check failed:', e);
      }
      return false;
    }

    // Display user information
    function displayUserInfo() {
      userContext = getUserContext();
      if (userContext) {
        document.getElementById('userName').textContent = userContext.name;
        document.getElementById('userToken').textContent = userContext.token;
        document.getElementById('userCollege').textContent = userContext.college;
        userInfo.style.display = 'block';
      } else {
        // Redirect to registration if no user context
        alert('Please complete registration first.');
        window.location.href = 'register.html';
      }
    }

    // Render events grid
    function renderEvents() {
      eventsGrid.innerHTML = '';
      
      EVENTS_DATA.forEach(event => {
        const eventCard = document.createElement('div');
        eventCard.className = 'event-card';
        eventCard.dataset.eventId = event.id;
        
        eventCard.innerHTML = `
          <div class="event-price-badge">₹100</div>
          <div class="event-content">
            <div class="event-title">${event.title}</div>
            <div class="event-description">${event.description}</div>
          </div>
          <div class="event-actions">
            <button class="select-btn" data-event-id="${event.id}">Select</button>
          </div>
        `;
        
        // Add select button handler
        const selectBtn = eventCard.querySelector('.select-btn');
        selectBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleEventSelection(event.id);
        });
        
        eventsGrid.appendChild(eventCard);
      });
    }

    // Toggle event selection
    function toggleEventSelection(eventId) {
      console.log('Toggling event:', eventId);
      const eventCard = document.querySelector(`[data-event-id="${eventId}"]`);
      const selectBtn = eventCard.querySelector('.select-btn');
      
      if (selectedEvents[eventId]) {
        // Deselect event
        delete selectedEvents[eventId];
        eventCard.classList.remove('selected');
        selectBtn.classList.remove('selected');
        selectBtn.textContent = 'Select';
      } else {
        // Select event with default quantity of 1
        selectedEvents[eventId] = 1;
        eventCard.classList.add('selected');
        selectBtn.classList.add('selected');
        selectBtn.textContent = 'Unselect';
      }
      
      console.log('Current selected events:', selectedEvents);
      updateSelectionSummary();
    }

    // Update selection summary
    function updateSelectionSummary() {
      const hasSelections = Object.keys(selectedEvents).length > 0;
      
      if (hasSelections) {
        selectionSummary.classList.add('show');
        document.body.classList.add('has-summary');
        
        let summaryHTML = '';
        
        Object.entries(selectedEvents).forEach(([eventId]) => {
          const event = EVENTS_DATA.find(e => e.id === eventId);
          
          summaryHTML += `
            <div class="summary-item">
              <span>${event.title}</span>
              <span>✓ Selected</span>
            </div>
          `;
        });
        
        summaryItems.innerHTML = summaryHTML;
        
        // Calculate event count and total amount
        const eventCount = Object.keys(selectedEvents).length;
        const totalAmount = eventCount * 100;
        
        // Update DOM elements
        document.getElementById('eventCount').textContent = eventCount;
        document.getElementById('totalAmount').textContent = `₹${totalAmount}`;
        
        // Store in sessionStorage
        sessionStorage.setItem('eventCount', String(eventCount));
        sessionStorage.setItem('totalAmount', String(totalAmount));
        
      } else {
        selectionSummary.classList.remove('show');
        document.body.classList.remove('has-summary');
        
        // Reset values when no events selected
        sessionStorage.setItem('eventCount', '0');
        sessionStorage.setItem('totalAmount', '0');
      }
    }

    // Proceed to payment
    async function proceedToPayment() {
      console.log('Submit button clicked!');
      console.log('Selected events:', selectedEvents);
      
      if (Object.keys(selectedEvents).length === 0) {
        console.warn('No events selected');
        alert('Please select at least one event.');
        return;
      }

      if (!userContext) {
        console.warn('No user context found');
        alert('User session expired. Please register again.');
        window.location.href = 'register.html';
        return;
      }

      console.log('User context:', userContext);
      showLoader('Saving your event selections...');

      try {
        // Prepare event selections without pricing
        const eventSelections = [];

        Object.entries(selectedEvents).forEach(([eventId, quantity]) => {
          const event = EVENTS_DATA.find(e => e.id === eventId);
          
          eventSelections.push({
            eventId,
            eventTitle: event.title,
            quantity,
            maxParticipants: event.maxParticipants
          });
        });

        console.log('Event selections prepared:', eventSelections);

        // Find user by shortId
        const registrationsRef = collection(db, 'registrations');
        const querySnapshot = await getDocs(query(registrationsRef, where('shortId', '==', userContext.token)));
        console.log('Query snapshot:', querySnapshot);

        if (querySnapshot.empty) {
          throw new Error('User registration not found. Please register again.');
        }

        // Use the first matching document
        const userDocData = querySnapshot.docs[0];
        console.log('User document found:', userDocData.id);

        // Calculate total amount and event count
        const eventCount = Object.keys(selectedEvents).length;
        const totalAmount = eventCount * 100;
        console.log('Event count:', eventCount);
        console.log('Total amount calculated:', totalAmount);
        
        // Ensure sessionStorage has the latest values
        sessionStorage.setItem('eventCount', String(eventCount));
        sessionStorage.setItem('totalAmount', String(totalAmount));

        // Persist selections in eventSelections (rules allow create here)
        const eventSelectionsRef = collection(db, 'eventSelections');
        const selectionDocRef = doc(eventSelectionsRef, `${userContext.token}_${Date.now()}`);
        console.log('Creating selection document:', selectionDocRef.id);
        await setDoc(selectionDocRef, {
          userId: userDocData.id,
          userToken: userContext.token,
          selections: eventSelections,
          eventCount: eventCount,
          totalAmount: totalAmount,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          paymentStatus: 'pending'
        });
        console.log('Selection document created successfully');

        // Best-effort: link selection to registration (ignore if denied by rules)
        try {
          console.log('Attempting to update registration document');
          await updateDoc(userDocData.ref, {
            hasSelectedEvents: true,
            eventSelectionId: selectionDocRef.id,
            eventSelectionTimestamp: serverTimestamp(),
            eventCount: eventCount,
            totalAmount: totalAmount
          });
          console.log('Registration document updated successfully');
        } catch (linkErr) {
          console.warn('Linking selection to registration was skipped due to rules:', linkErr?.message || linkErr);
        }

        // Store selections in session storage for payment page
        sessionStorage.setItem('eventSelections', JSON.stringify(eventSelections));
        sessionStorage.setItem('totalAmount', String(totalAmount));
        sessionStorage.setItem('payment_user_context', JSON.stringify({
          name: userContext.name,
          token: userContext.token,
          college: userContext.college
        }));
        console.log('Session storage updated');

        hideLoader();

        // Set submission lock so user cannot come back and resubmit
        try {
          sessionStorage.setItem('events_submitted_token', userContext.token);
          sessionStorage.setItem('events_submitted_time', String(Date.now()));
        } catch (e) { console.warn('Failed to set submission lock:', e); }

        // Redirect to final step page
        console.log('Redirecting to success page');
        window.location.href = 'success.html';

      } catch (error) {
        console.error('Error saving event selections:', {
          message: error?.message || String(error),
          code: error?.code,
          stack: error?.stack
        });
        hideLoader();
        alert('Failed to save event selections. Please try again. Error: ' + (error?.message || 'Unknown error'));
      }
    }

    // Initialize page
    function init() {
      console.log('Initializing events page...');
      
      // If already submitted, redirect to success immediately
      if (enforceSubmissionLock()) return;

      displayUserInfo();
      renderEvents();
      
      // Add proceed button handler
      if (proceedBtn) {
        console.log('Submit button found, adding click handler');
        proceedBtn.addEventListener('click', proceedToPayment);
        console.log('Click handler attached successfully');
      } else {
        console.error('Submit button not found!');
      }

      // Handle back-forward cache returns: re-check lock and redirect if needed
      window.addEventListener('pageshow', () => {
        enforceSubmissionLock();
      });
    }

    // Global error handler
    window.addEventListener('error', (e) => {
      console.error('Global error:', e.error);
      console.error('Error message:', e.message);
      console.error('Error filename:', e.filename);
      console.error('Error line:', e.lineno);
    });

    // Start the application
    try {
      init();
    } catch (e) {
      console.error('Failed to initialize:', e);
      alert('Failed to load page. Please refresh and try again.');
    }
  </script>
</body>
</html>
